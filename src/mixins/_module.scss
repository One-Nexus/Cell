@use "sass:list";
@use "sass:map";
@use "sass:meta";
@use "sass:string";

/// Create a new module
///
/// @param {string} $module - The module you wish to create
/// @param {map} $content
/// @param {map} $config
@mixin module($module: null, $content: (), $config: if(global-variable-exists('config'), $config, ())) {
  $nested: &;
  $selectors: ();
  $uid: string.unique-id();

  $useScopeAsNamespace: true;

  @if not $module {
    @if (map.has-key($config, "name")) {
      $module: map.get($config, "name");
    } @else {
      $module: $uid;
    }
  }

  $namespace: $module;

  $scopeId: if(
    map.has-key($config, "scope"), 
    map.get($config, "scope"), 
    if(global-variable-exists('scope'), $scope, null)
  );

  @if ($scopeId) {
    $namespace: if($useScopeAsNamespace, $scopeId, #{$scopeId}-#{$namespace});
  }

  // We are creating a root module, so create a global variable
  @if not $nested {
    $module: $module !global;
    $globalNamespace: $namespace !global;
    $this: $module !global;
  }

  @each $module in $module {
    $selectors: join($selectors, ".#{$namespace}", comma);
    $selectors: join($selectors, '[class*="#{$namespace}#{$modifierGlue}"]', comma);
  }

  #{$selectors} {
    @if not $nested {
      @include module-content($module, $config);
    }

    @content;

    @include parse-cq($content);
  }
}

/// Render a module's content
///
/// @param {string|list} $module
/// @param {map} $config
/// @param {string} $uid
@mixin module-content($module, $config) {
  /// Extend modifiers into the naked module
  @if map.get($config, "modifiers") {
    @include extend(map.get($config, "modifiers"));
  }

  /// Combine modifiers into a new, single modifier
  @if map.get($config, "combine") {
    @each $new-modifier, $target-modifiers in map.get($config, "combine") {
      @include modifier($new-modifier) {
        @include extend(($target-modifiers));
      }
    }
  }

  @if $outputCSSFromConfig and $module == map.get($config, "name") {
    @include parse-cq($config);
  }
}
