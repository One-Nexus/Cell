@use "sass:list";
@use "sass:map";
@use "sass:meta";
@use "sass:string";

/// Create a new module
///
/// @param {string} $module - The module you wish to create
/// @param {map} $content
/// @param {map} $config
@mixin module(
  $module: null, 
  $content: (), 
  $config: if(global-variable-exists('config'), $config, ()),
  $theme: if(global-variable-exists('theme'), $theme, ())
) {
  $nested: &;
  $selectors: ();
  $scopeId: configVal($config, "scope", if(global-variable-exists('scope'), $scope, null));

  $scopedCSS: getRootConfigOpt("scopedCSS", false, $config, $theme) !default;
  $useScopeAsNamespace: getRootConfigOpt("useScopeAsNamespace", false, $config, $theme) !default;
  $outputCSSFromConfig: getRootConfigOpt("outputCSSFromConfig", false, $config, $theme) !default;

  @if not $module {
    @if (map.has-key($config, "name")) {
      $module: map.get($config, "name");
    } @else {
      $module: string.unique-id();
    }
  }

  $namespace: $module;

  @if ($scopeId and $scopedCSS) {
    $namespace: if($useScopeAsNamespace, $scopeId, #{$scopeId}-#{$namespace});
  }

  // We are creating a root module, so create a global variable
  @if not $nested {
    $module: $module !global;
    $this: $module !global;
    $globalNamespace: $namespace !global;
    $globalScopedCss: $scopedCSS !global;
  }

  @each $module in $module {
    $selectors: join($selectors, ".#{$namespace}", comma);
    $selectors: join($selectors, '[class*="#{$namespace}#{$modifierGlue}"]', comma);
  }

  #{$selectors} {
    @if not $nested {
      @include module-content($module, $config, $outputCSSFromConfig);
    }

    @content;

    @include parse-cq($content);
  }
}

/// Render a module's content
@mixin module-content($module, $config, $outputCSSFromConfig) {
  /// Extend modifiers into the naked module
  @if map.get($config, "modifiers") {
    @include extend(map.get($config, "modifiers"));
  }

  /// Combine modifiers into a new, single modifier
  @if map.get($config, "combine") {
    @each $new-modifier, $target-modifiers in map.get($config, "combine") {
      @include modifier($new-modifier) {
        @include extend(($target-modifiers));
      }
    }
  }

  @if $outputCSSFromConfig and $module == map.get($config, "name") {
    @include parse-cq($config);
  }
}

// Helpers
@function configVal($config, $value, $default) {
  @return if(map.has-key($config, $value), map.get($config, $value), $default);
};

@function themeVal($theme, $value, $default) {
  @return if(map.has-key($theme, $value), map.get($theme, $value), $default);
};

@function getRootConfigOpt($value, $default, $config, $theme) {
  @return configVal($config, $value, themeVal($theme, $value, $default));
}
